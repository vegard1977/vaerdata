<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>V√¶rdata Siljan</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #1a1a2e;
      color: #eee;
      padding: 20px;
      min-height: 100vh;
    }
    h1 { text-align: center; margin-bottom: 10px; font-size: 1.5rem; }
    .updated { text-align: center; color: #888; font-size: 0.85rem; margin-bottom: 20px; }
    .section-title {
      font-size: 0.85rem;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin: 30px 0 15px 0;
      padding-bottom: 5px;
      border-bottom: 1px solid #333;
      max-width: 1200px;
      margin-left: auto;
      margin-right: auto;
    }
    .section-title:first-of-type { margin-top: 0; }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 15px;
      max-width: 1200px;
      margin: 0 auto;
    }
    .card {
      background: #252542;
      border-radius: 10px;
      padding: 15px;
    }
    .card h2 {
      font-size: 0.9rem;
      color: #888;
      margin-bottom: 10px;
      border-bottom: 1px solid #333;
      padding-bottom: 5px;
    }
    .card.regional { border-left: 3px solid #8b5cf6; }
    .card.metno { border-left: 3px solid #06b6d4; }
    .card.water { border-left: 3px solid #3b82f6; }
    .card.alert { border-left: 3px solid #22c55e; }
    .card.alert.yellow { border-left-color: #eab308; background: #2a2a1e; }
    .card.alert.orange { border-left-color: #f97316; background: #2a241e; }
    .card.alert.red { border-left-color: #ef4444; background: #2a1e1e; }
    .value { font-size: 2rem; font-weight: bold; }
    .unit { font-size: 0.9rem; color: #888; }
    .beaufort { font-size: 1rem; color: #4ade80; margin-top: 5px; }
    .stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px; }
    .stats-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 10px; }
    .stats-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 10px; }
    .stat { text-align: center; }
    .stat-label { font-size: 0.7rem; color: #666; }
    .stat-value { font-size: 1rem; font-weight: bold; }
    .stat-detail { font-size: 0.65rem; color: #888; }
    .trend-up { color: #4ade80; }
    .trend-down { color: #f87171; }
    .sun { color: #fbbf24; }
    .wind-calm { color: #4ade80; }
    .wind-moderate { color: #fbbf24; }
    .wind-strong { color: #f87171; }
    .temp-cold { color: #60a5fa; }
    .temp-warm { color: #f87171; }
    .uv-low { color: #4ade80; }
    .uv-moderate { color: #fbbf24; }
    .uv-high { color: #f97316; }
    .uv-very-high { color: #ef4444; }
    .uv-extreme { color: #a855f7; }
    .wind-dir { font-size: 1.5rem; }
    
    /* Water level colors */
    .fill-low { color: #60a5fa; }
    .fill-mid { color: #4ade80; }
    .fill-high { color: #fbbf24; }
    .fill-full { color: #f97316; }
    .fill-over { color: #ef4444; }
    
    /* Forecast styles */
    .forecast-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 10px;
      margin-top: 10px;
    }
    .forecast-day {
      text-align: center;
      padding: 10px 5px;
      background: #1a1a2e;
      border-radius: 8px;
    }
    .forecast-day .day-name { font-size: 0.75rem; color: #888; margin-bottom: 5px; }
    .forecast-day .weather-icon { font-size: 1.5rem; margin: 5px 0; }
    .forecast-day .temp-range { font-size: 0.8rem; }
    .forecast-day .precip { font-size: 0.7rem; color: #60a5fa; margin-top: 3px; }
    
    /* Alert styles */
    .alert-content { font-size: 0.85rem; line-height: 1.4; }
    .alert-title { font-weight: bold; margin-bottom: 5px; }
    .alert-desc { color: #aaa; }
    .alert-none { color: #4ade80; }
    
    /* Water level grid */
    .water-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 10px;
      margin-top: 10px;
    }
    .water-item {
      text-align: center;
      padding: 12px 8px;
      background: #1a1a2e;
      border-radius: 8px;
    }
    .water-item .reservoir-name { font-size: 0.75rem; color: #888; margin-bottom: 8px; font-weight: 500; }
    .water-item .water-level { font-size: 1.1rem; font-weight: bold; }
    .water-item .water-ref { font-size: 0.65rem; color: #666; margin-top: 4px; }
    .water-item .fill-pct { font-size: 1.3rem; font-weight: bold; margin-top: 6px; }
    .water-item .fill-bar {
      height: 4px;
      background: #333;
      border-radius: 2px;
      margin-top: 6px;
      overflow: hidden;
    }
    .water-item .fill-bar-inner {
      height: 100%;
      border-radius: 2px;
      transition: width 0.3s;
    }
    
    @media (max-width: 768px) {
      .forecast-grid {
        grid-template-columns: repeat(4, 1fr);
      }
      .forecast-day:nth-child(n+5) {
        display: none;
      }
      .water-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      .water-item:nth-child(5) {
        grid-column: 1 / -1;
        max-width: 50%;
        margin: 0 auto;
      }
    }
  </style>
</head>
<body>
  <h1>üå§Ô∏è V√¶rdata Siljan</h1>
  <div class="updated">Sist oppdatert: <span id="lastUpdate">--</span></div>

  <!-- Farevarsler √∏verst -->
  <div class="grid" style="margin-bottom: 15px;">
    <div class="card alert" id="alertCard" style="grid-column: 1 / -1;">
      <h2>‚ö†Ô∏è Farevarsler</h2>
      <div class="alert-content" id="alertContent">
        <span class="alert-none">‚úì Ingen aktive farevarsler for Siljan</span>
      </div>
    </div>
  </div>
  
  <div class="section-title">üìç Lokale m√•linger</div>
  <div class="grid">
    <!-- Temperatur -->
    <div class="card">
      <h2>üå°Ô∏è Temperatur</h2>
      <span class="value" id="temp">--</span><span class="unit">¬∞C</span>
      <div class="stats">
        <div class="stat">
          <div class="stat-label">24t min/max</div>
          <div class="stat-value"><span id="temp24min">--</span> / <span id="temp24max">--</span></div>
          <div class="stat-detail" id="temp24times">--</div>
        </div>
        <div class="stat">
          <div class="stat-label">7d min/max</div>
          <div class="stat-value"><span id="temp7min">--</span> / <span id="temp7max">--</span></div>
          <div class="stat-detail" id="temp7times">--</div>
        </div>
        <div class="stat">
          <div class="stat-label">30d min/max</div>
          <div class="stat-value"><span id="temp30min">--</span> / <span id="temp30max">--</span></div>
          <div class="stat-detail" id="temp30times">--</div>
        </div>
      </div>
    </div>

    <!-- Irradiance -->
    <div class="card">
      <h2>‚òÄÔ∏è Solinnstr√•ling</h2>
      <span class="value" id="irr">--</span><span class="unit">W/m¬≤</span>
      <div class="stats">
        <div class="stat">
          <div class="stat-label">Maks i dag</div>
          <div class="stat-value" id="irrMax">--</div>
          <div class="stat-detail" id="irrMaxTime">--</div>
        </div>
        <div class="stat">
          <div class="stat-label">Solskinn 24t</div>
          <div class="stat-value sun" id="sun24">--</div>
        </div>
        <div class="stat">
          <div class="stat-label">Solskinn 7d</div>
          <div class="stat-value sun" id="sun7">--</div>
        </div>
      </div>
    </div>

    <!-- UV-indeks -->
    <div class="card">
      <h2>‚òÄÔ∏è UV-indeks</h2>
      <span class="value" id="uv">--</span>
      <div class="beaufort" id="uvLevel">--</div>
      <div class="stats">
        <div class="stat">
          <div class="stat-label">Maks 24t</div>
          <div class="stat-value" id="uv24max">--</div>
          <div class="stat-detail" id="uv24time">--</div>
        </div>
        <div class="stat">
          <div class="stat-label">Maks 7d</div>
          <div class="stat-value" id="uv7max">--</div>
          <div class="stat-detail" id="uv7date">--</div>
        </div>
        <div class="stat">
          <div class="stat-label">Maks 30d</div>
          <div class="stat-value" id="uv30max">--</div>
          <div class="stat-detail" id="uv30date">--</div>
        </div>
      </div>
    </div>

    <!-- Vind -->
    <div class="card">
      <h2>üí® Vind</h2>
      <span class="value" id="wind">--</span><span class="unit">km/h</span>
      <div class="beaufort" id="beaufort">--</div>
      <div class="stats">
        <div class="stat">
          <div class="stat-label">Maks 24t</div>
          <div class="stat-value" id="wind24max">--</div>
          <div class="stat-detail" id="wind24time">--</div>
        </div>
        <div class="stat">
          <div class="stat-label">Maks 7d</div>
          <div class="stat-value" id="wind7max">--</div>
          <div class="stat-detail" id="wind7time">--</div>
        </div>
        <div class="stat">
          <div class="stat-label">Maks 30d</div>
          <div class="stat-value" id="wind30max">--</div>
          <div class="stat-detail" id="wind30time">--</div>
        </div>
      </div>
    </div>

    <!-- Nedb√∏r -->
    <div class="card">
      <h2>üåßÔ∏è Nedb√∏r</h2>
      <span class="value" id="rainToday">--</span><span class="unit">mm i dag</span>
      <div class="stats">
        <div class="stat">
          <div class="stat-label">Siste 24t</div>
          <div class="stat-value" id="rain24">--</div>
        </div>
        <div class="stat">
          <div class="stat-label">Siste 7d</div>
          <div class="stat-value" id="rain7">--</div>
        </div>
        <div class="stat">
          <div class="stat-label">Siste 30d</div>
          <div class="stat-value" id="rain30">--</div>
        </div>
      </div>
    </div>

    <!-- Nedb√∏r statistikk -->
    <div class="card">
      <h2>üìä Nedb√∏r statistikk</h2>
      <div class="stats">
        <div class="stat">
          <div class="stat-label">Maks dag 7d</div>
          <div class="stat-value" id="rainMax7">--</div>
          <div class="stat-detail" id="rainMax7date">--</div>
        </div>
        <div class="stat">
          <div class="stat-label">Maks dag 30d</div>
          <div class="stat-value" id="rainMax30">--</div>
          <div class="stat-detail" id="rainMax30date">--</div>
        </div>
        <div class="stat">
          <div class="stat-label">Regndager</div>
          <div class="stat-value"><span id="rainDays7">--</span> / <span id="rainDays30">--</span></div>
          <div class="stat-detail">(7d / 30d)</div>
        </div>
      </div>
      <div class="stats-2">
        <div class="stat">
          <div class="stat-label">Lengste t√∏rrperiode</div>
          <div class="stat-value" id="dryStreak">--</div>
          <div class="stat-detail">(siste 30d)</div>
        </div>
        <div class="stat">
          <div class="stat-label">Snitt per regndag</div>
          <div class="stat-value" id="rainAvgPerDay">--</div>
          <div class="stat-detail">(siste 30d)</div>
        </div>
      </div>
    </div>

    <!-- Fuktighet & Dugpunkt -->
    <div class="card">
      <h2>üíß Fuktighet</h2>
      <span class="value" id="hum">--</span><span class="unit">%</span>
      <div class="stats">
        <div class="stat">
          <div class="stat-label">Dugpunkt</div>
          <div class="stat-value" id="dew">--</div>
        </div>
        <div class="stat">
          <div class="stat-label">24t min/max</div>
          <div class="stat-value"><span id="hum24min">--</span>/<span id="hum24max">--</span></div>
          <div class="stat-detail" id="hum24times">--</div>
        </div>
        <div class="stat">
          <div class="stat-label">Snitt 7d</div>
          <div class="stat-value" id="hum7avg">--</div>
        </div>
      </div>
    </div>

    <!-- Trykk -->
    <div class="card">
      <h2>üåÄ Lufttrykk</h2>
      <span class="value" id="press">--</span><span class="unit">hPa</span>
      <div class="stats">
        <div class="stat">
          <div class="stat-label">Trend 3t</div>
          <div class="stat-value" id="pressTrend">--</div>
        </div>
        <div class="stat">
          <div class="stat-label">24t min/max</div>
          <div class="stat-value"><span id="press24min">--</span>/<span id="press24max">--</span></div>
          <div class="stat-detail" id="press24times">--</div>
        </div>
        <div class="stat">
          <div class="stat-label">Snitt 7d</div>
          <div class="stat-value" id="press7avg">--</div>
        </div>
      </div>
    </div>
  </div>

  <div class="section-title">üåê Met.no Prognose</div>
  <div class="grid">
    <!-- 7-dagers varsel -->
    <div class="card metno" style="grid-column: 1 / -1;">
      <h2>üìÖ V√¶rvarsel 7 dager</h2>
      <div class="forecast-grid" id="forecastGrid">
        <div class="forecast-day"><div class="day-name">--</div><div class="weather-icon">--</div><div class="temp-range">--</div></div>
        <div class="forecast-day"><div class="day-name">--</div><div class="weather-icon">--</div><div class="temp-range">--</div></div>
        <div class="forecast-day"><div class="day-name">--</div><div class="weather-icon">--</div><div class="temp-range">--</div></div>
        <div class="forecast-day"><div class="day-name">--</div><div class="weather-icon">--</div><div class="temp-range">--</div></div>
        <div class="forecast-day"><div class="day-name">--</div><div class="weather-icon">--</div><div class="temp-range">--</div></div>
        <div class="forecast-day"><div class="day-name">--</div><div class="weather-icon">--</div><div class="temp-range">--</div></div>
        <div class="forecast-day"><div class="day-name">--</div><div class="weather-icon">--</div><div class="temp-range">--</div></div>
      </div>
    </div>

    <!-- Vindkast & Retning -->
    <div class="card metno">
      <h2>üí® Vindkast & Retning</h2>
      <span class="value" id="windGust">--</span><span class="unit">km/h</span>
      <div class="stats-2">
        <div class="stat">
          <div class="stat-label">Retning</div>
          <div class="stat-value"><span class="wind-dir" id="windDirArrow">--</span> <span id="windDirText">--</span></div>
          <div class="stat-detail" id="windDirDeg">--</div>
        </div>
        <div class="stat">
          <div class="stat-label">Maks kast 24t</div>
          <div class="stat-value" id="gust24max">--</div>
          <div class="stat-detail" id="gust24time">--</div>
        </div>
      </div>
    </div>

    <!-- Skydekke & T√•ke -->
    <div class="card metno">
      <h2>‚òÅÔ∏è Skydekke & T√•ke</h2>
      <span class="value" id="clouds">--</span><span class="unit">%</span>
      <div class="stats">
        <div class="stat">
          <div class="stat-label">T√•ke</div>
          <div class="stat-value" id="fog">--</div>
        </div>
        <div class="stat">
          <div class="stat-label">Min 24t</div>
          <div class="stat-value" id="clouds24min">--</div>
          <div class="stat-detail" id="clouds24minTime">--</div>
        </div>
        <div class="stat">
          <div class="stat-label">Maks 24t</div>
          <div class="stat-value" id="clouds24max">--</div>
          <div class="stat-detail" id="clouds24maxTime">--</div>
        </div>
      </div>
    </div>

    <!-- Nedb√∏r & Torden sannsynlighet -->
    <div class="card metno">
      <h2>üåßÔ∏è Sannsynlighet & Varsel</h2>
      <div class="stats-2">
        <div class="stat">
          <div class="stat-label">Nedb√∏r n√•</div>
          <div class="stat-value" id="precipProb">--</div>
        </div>
        <div class="stat">
          <div class="stat-label">Neste time</div>
          <div class="stat-value" id="precipNextHour">--</div>
        </div>
      </div>
      <div class="stats-2">
        <div class="stat">
          <div class="stat-label">Torden n√•</div>
          <div class="stat-value" id="thunderProb">--</div>
        </div>
        <div class="stat">
          <div class="stat-label">Maks torden 24t</div>
          <div class="stat-value" id="thunderProb24max">--</div>
          <div class="stat-detail" id="thunderProb24time">--</div>
        </div>
      </div>
    </div>
  </div>

  <div class="section-title">üìç Siljan regionalt</div>
  <div class="grid">
    <!-- Siljan Temperatur Regional -->
    <div class="card regional">
      <h2>üå°Ô∏è Temperatur (regionalt)</h2>
      <div class="stats-2">
        <div class="stat">
          <div class="stat-label">Min i dag</div>
          <div class="stat-value temp-cold" id="siljanTempMin">--</div>
        </div>
        <div class="stat">
          <div class="stat-label">Max i dag</div>
          <div class="stat-value temp-warm" id="siljanTempMax">--</div>
        </div>
      </div>
      <div class="stats-4">
        <div class="stat">
          <div class="stat-label">Laveste 7d</div>
          <div class="stat-value temp-cold" id="siljanTempMin7">--</div>
          <div class="stat-detail" id="siljanTempMin7date">--</div>
        </div>
        <div class="stat">
          <div class="stat-label">H√∏yeste 7d</div>
          <div class="stat-value temp-warm" id="siljanTempMax7">--</div>
          <div class="stat-detail" id="siljanTempMax7date">--</div>
        </div>
        <div class="stat">
          <div class="stat-label">Laveste 30d</div>
          <div class="stat-value temp-cold" id="siljanTempMin30">--</div>
          <div class="stat-detail" id="siljanTempMin30date">--</div>
        </div>
        <div class="stat">
          <div class="stat-label">H√∏yeste 30d</div>
          <div class="stat-value temp-warm" id="siljanTempMax30">--</div>
          <div class="stat-detail" id="siljanTempMax30date">--</div>
        </div>
      </div>
    </div>

    <!-- Siljan Vind Regional -->
    <div class="card regional">
      <h2>üí® Vind (regionalt maks)</h2>
      <span class="value" id="siljanWindMax">--</span><span class="unit">km/h</span>
      <div class="beaufort" id="siljanWindBeaufort">--</div>
      <div class="stats">
        <div class="stat">
          <div class="stat-label">Maks 7d</div>
          <div class="stat-value" id="siljanWind7max">--</div>
          <div class="stat-detail" id="siljanWind7date">--</div>
        </div>
        <div class="stat">
          <div class="stat-label">Maks 30d</div>
          <div class="stat-value" id="siljanWind30max">--</div>
          <div class="stat-detail" id="siljanWind30date">--</div>
        </div>
        <div class="stat">
          <div class="stat-label">Snitt maks/dag</div>
          <div class="stat-value" id="siljanWindAvg">--</div>
          <div class="stat-detail">(30d)</div>
        </div>
      </div>
    </div>

    <!-- Siljan Nedb√∏r Regional -->
    <div class="card regional">
      <h2>üåßÔ∏è Nedb√∏r (regionalt maks)</h2>
      <span class="value" id="siljanRainMax">--</span><span class="unit">mm i dag</span>
      <div class="stats">
        <div class="stat">
          <div class="stat-label">Maks dag 7d</div>
          <div class="stat-value" id="siljanRain7max">--</div>
          <div class="stat-detail" id="siljanRain7date">--</div>
        </div>
        <div class="stat">
          <div class="stat-label">Maks dag 30d</div>
          <div class="stat-value" id="siljanRain30max">--</div>
          <div class="stat-detail" id="siljanRain30date">--</div>
        </div>
        <div class="stat">
          <div class="stat-label">Snitt maks/dag</div>
          <div class="stat-value" id="siljanRainAvg">--</div>
          <div class="stat-detail">(30d)</div>
        </div>
      </div>
    </div>
  </div>

  <div class="section-title">üíß Vannstander Siljanvassdraget</div>
  <div class="grid">
    <div class="card water" style="grid-column: 1 / -1;">
      <h2>üèîÔ∏è Magasinfylling</h2>
      <div class="water-grid" id="waterGrid">
        <div class="water-item"><div class="reservoir-name">--</div><div class="fill-pct">--%</div></div>
        <div class="water-item"><div class="reservoir-name">--</div><div class="fill-pct">--%</div></div>
        <div class="water-item"><div class="reservoir-name">--</div><div class="fill-pct">--%</div></div>
        <div class="water-item"><div class="reservoir-name">--</div><div class="fill-pct">--%</div></div>
        <div class="water-item"><div class="reservoir-name">--</div><div class="fill-pct">--%</div></div>
      </div>
      <div class="updated" style="margin-top: 15px; margin-bottom: 0;">
        Kilde: <a href="https://www.skagerakkraft.no/vassdrag/vannstand/" target="_blank" style="color: #888;">Skagerak Kraft</a> ¬∑ 
        Oppdatert: <span id="waterUpdate">--</span>
      </div>
    </div>
  </div>

  <script>
    // Supabase config v1.7
    // Changelog:
    //   v1.0 - Initial version
    //   v1.1 - Added timestamps for min/max values
    //   v1.2 - Added rain statistics card
    //   v1.3 - Added wind card with Beaufort scale
    //   v1.4 - Added Siljan regional cards, changed wind to Snurrasen
    //   v1.5 - Added UV index, met.no data, reorganized layout
    //   v1.6 - Added 7-day forecast, MetAlerts, fog, precip next hour (direct from met.no)
    //   v1.7 - Added water levels section for Siljanvassdraget reservoirs
    
    const SUPABASE_URL = 'https://ygxhkdwhjyqpkmfzezxv.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_wiJxJlwGbklxNgNjL4riJg_Hh55ayG0';
    const METNO_LAT = 59.2924;
    const METNO_LON = 9.7072;

    // Weather symbol to emoji mapping
    const weatherIcons = {
      clearsky_day: '‚òÄÔ∏è', clearsky_night: 'üåô', clearsky_polartwilight: 'üåÖ',
      fair_day: 'üå§Ô∏è', fair_night: 'üå§Ô∏è', fair_polartwilight: 'üå§Ô∏è',
      partlycloudy_day: '‚õÖ', partlycloudy_night: '‚õÖ', partlycloudy_polartwilight: '‚õÖ',
      cloudy: '‚òÅÔ∏è',
      rainshowers_day: 'üå¶Ô∏è', rainshowers_night: 'üå¶Ô∏è', rainshowers_polartwilight: 'üå¶Ô∏è',
      rainshowersandthunder_day: '‚õàÔ∏è', rainshowersandthunder_night: '‚õàÔ∏è',
      sleetshowers_day: 'üå®Ô∏è', sleetshowers_night: 'üå®Ô∏è',
      snowshowers_day: 'üå®Ô∏è', snowshowers_night: 'üå®Ô∏è',
      rain: 'üåßÔ∏è', heavyrain: 'üåßÔ∏è', lightrain: 'üåßÔ∏è',
      rainandthunder: '‚õàÔ∏è', heavyrainandthunder: '‚õàÔ∏è', lightrainandthunder: '‚õàÔ∏è',
      sleet: 'üå®Ô∏è', heavysleet: 'üå®Ô∏è', lightsleet: 'üå®Ô∏è',
      snow: '‚ùÑÔ∏è', heavysnow: '‚ùÑÔ∏è', lightsnow: '‚ùÑÔ∏è',
      snowandthunder: '‚õàÔ∏è', sleetandthunder: '‚õàÔ∏è',
      fog: 'üå´Ô∏è',
    };

    function getWeatherIcon(symbolCode) {
      if (!symbolCode) return '‚ùì';
      const base = symbolCode.replace(/_day|_night|_polartwilight/g, '');
      return weatherIcons[symbolCode] || weatherIcons[base] || '‚ùì';
    }

    async function fetchData(table, select = '*', filter = '', order = '', limit = '') {
      let url = `${SUPABASE_URL}/rest/v1/${table}?select=${select}`;
      if (filter) url += `&${filter}`;
      if (order) url += `&order=${order}`;
      if (limit) url += `&limit=${limit}`;
      
      const res = await fetch(url, {
        headers: {
          'apikey': SUPABASE_KEY,
          'Authorization': `Bearer ${SUPABASE_KEY}`
        }
      });
      return res.json();
    }

    async function fetchMetNo(endpoint) {
      const res = await fetch(`https://api.met.no/weatherapi/${endpoint}`, {
        headers: { 'User-Agent': 'SiljanWeather/1.0 github.com/vegard1977/vaerdata' }
      });
      return res.json();
    }

    function fmt(val, decimals = 1) {
      if (val === null || val === undefined || val === Infinity || val === -Infinity) return '--';
      return Number(val).toFixed(decimals);
    }

    function fmtTime(isoString) {
      if (!isoString) return '--';
      const d = new Date(isoString);
      return d.toLocaleTimeString('no-NO', { hour: '2-digit', minute: '2-digit' });
    }

    function fmtDateTime(isoString) {
      if (!isoString) return '--';
      const d = new Date(isoString);
      return d.toLocaleString('no-NO', { 
        day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' 
      });
    }

    function fmtShortDate(isoString) {
      if (!isoString) return '--';
      const d = new Date(isoString);
      return d.toLocaleDateString('no-NO', { weekday: 'short', day: 'numeric' });
    }

    function fmtDayMonth(isoString) {
      if (!isoString) return '--';
      const d = new Date(isoString);
      return d.toLocaleDateString('no-NO', { day: 'numeric', month: 'short' });
    }

    function fmtDayName(isoString) {
      if (!isoString) return '--';
      const d = new Date(isoString);
      const today = new Date();
      const tomorrow = new Date(today);
      tomorrow.setDate(tomorrow.getDate() + 1);
      
      if (d.toDateString() === today.toDateString()) return 'I dag';
      if (d.toDateString() === tomorrow.toDateString()) return 'I morgen';
      return d.toLocaleDateString('no-NO', { weekday: 'short', day: 'numeric' });
    }

    function hoursAgo(h) {
      return new Date(Date.now() - h * 60 * 60 * 1000).toISOString();
    }

    function daysAgo(d) {
      return new Date(Date.now() - d * 24 * 60 * 60 * 1000).toISOString();
    }

    function getDateKey(isoString) {
      const d = new Date(isoString);
      return d.toISOString().split('T')[0];
    }

    function findMinMax(data, field) {
      let min = { val: Infinity, time: null };
      let max = { val: -Infinity, time: null };
      for (const d of data) {
        if (d[field] !== null && d[field] !== undefined) {
          if (d[field] < min.val) { min.val = d[field]; min.time = d.recorded_at; }
          if (d[field] > max.val) { max.val = d[field]; max.time = d.recorded_at; }
        }
      }
      return { min, max };
    }

    function getBeaufort(kmh) {
      if (kmh === null || kmh === undefined) return { name: '--', class: '' };
      if (kmh < 1) return { name: 'Stille', class: 'wind-calm' };
      if (kmh < 6) return { name: 'Flau vind', class: 'wind-calm' };
      if (kmh < 12) return { name: 'Svak vind', class: 'wind-calm' };
      if (kmh < 20) return { name: 'Lett bris', class: 'wind-calm' };
      if (kmh < 29) return { name: 'Laber bris', class: 'wind-moderate' };
      if (kmh < 39) return { name: 'Frisk bris', class: 'wind-moderate' };
      if (kmh < 50) return { name: 'Liten kuling', class: 'wind-moderate' };
      if (kmh < 62) return { name: 'Stiv kuling', class: 'wind-strong' };
      if (kmh < 75) return { name: 'Sterk kuling', class: 'wind-strong' };
      if (kmh < 89) return { name: 'Liten storm', class: 'wind-strong' };
      if (kmh < 103) return { name: 'Full storm', class: 'wind-strong' };
      if (kmh < 118) return { name: 'Sterk storm', class: 'wind-strong' };
      return { name: 'Orkan', class: 'wind-strong' };
    }

    function getUvLevel(uv) {
      if (uv === null || uv === undefined) return { name: '--', class: '' };
      if (uv < 3) return { name: 'Lav', class: 'uv-low' };
      if (uv < 6) return { name: 'Moderat', class: 'uv-moderate' };
      if (uv < 8) return { name: 'H√∏y', class: 'uv-high' };
      if (uv < 11) return { name: 'Veldig h√∏y', class: 'uv-very-high' };
      return { name: 'Ekstrem', class: 'uv-extreme' };
    }

    function getWindDirection(deg) {
      if (deg === null || deg === undefined) return { arrow: '--', text: '--' };
      const directions = ['N', 'N√ò', '√ò', 'S√ò', 'S', 'SV', 'V', 'NV'];
      const arrows = ['‚Üì', '‚Üô', '‚Üê', '‚Üñ', '‚Üë', '‚Üó', '‚Üí', '‚Üò'];
      const index = Math.round(deg / 45) % 8;
      return { arrow: arrows[index], text: directions[index] };
    }

    function getFillColor(pct) {
      if (pct === null || pct === undefined) return { class: '', color: '#666' };
      if (pct > 100) return { class: 'fill-over', color: '#ef4444' };
      if (pct >= 80) return { class: 'fill-full', color: '#f97316' };
      if (pct >= 50) return { class: 'fill-mid', color: '#4ade80' };
      if (pct >= 25) return { class: 'fill-low', color: '#60a5fa' };
      return { class: 'fill-low', color: '#60a5fa' };
    }

    function calcDailyRain(data) {
      const dailyMax = {};
      for (const d of data) {
        if (d.rain_today === null || d.rain_today === undefined) continue;
        const dateKey = getDateKey(d.recorded_at);
        if (!dailyMax[dateKey] || d.rain_today > dailyMax[dateKey].val) {
          dailyMax[dateKey] = { val: d.rain_today, time: d.recorded_at };
        }
      }
      return dailyMax;
    }

    function calcRainStats(dailyMax, threshold = 0.2) {
      const days = Object.keys(dailyMax).sort();
      let rainDays = 0;
      let maxDay = { val: 0, date: null };
      let totalRain = 0;
      
      for (const day of days) {
        const rain = dailyMax[day].val;
        if (rain > threshold) {
          rainDays++;
          totalRain += rain;
        }
        if (rain > maxDay.val) {
          maxDay = { val: rain, date: dailyMax[day].time };
        }
      }

      let maxDryStreak = 0;
      let currentDryStreak = 0;
      for (const day of days) {
        if (dailyMax[day].val <= threshold) {
          currentDryStreak++;
          maxDryStreak = Math.max(maxDryStreak, currentDryStreak);
        } else {
          currentDryStreak = 0;
        }
      }

      const avgPerRainDay = rainDays > 0 ? totalRain / rainDays : 0;

      return { rainDays, maxDay, maxDryStreak, avgPerRainDay };
    }

    function calcDailyMax(data, field) {
      const dailyMax = {};
      for (const d of data) {
        if (d[field] === null || d[field] === undefined) continue;
        const dateKey = getDateKey(d.recorded_at);
        if (!dailyMax[dateKey] || d[field] > dailyMax[dateKey].val) {
          dailyMax[dateKey] = { val: d[field], time: d.recorded_at };
        }
      }
      return dailyMax;
    }

    async function updateWaterLevels() {
      try {
        // Hent siste m√•ling per magasin
        const reservoirs = ['Mykle', 'Sporevann', 'Gorningen', 'Vanebuvann', 'Ramsvatn'];
        const waterGrid = document.getElementById('waterGrid');
        waterGrid.innerHTML = '';
        
        let latestUpdate = null;
        
        for (const reservoir of reservoirs) {
          const data = await fetchData(
            'water_levels', 
            '*', 
            `reservoir=eq.${reservoir}`, 
            'timestamp.desc', 
            '1'
          );
          
          const item = document.createElement('div');
          item.className = 'water-item';
          
          if (data.length > 0) {
            const d = data[0];
            const level = d.water_level;
            const hrv = d.hrv;
            const lrv = d.lrv;
            const fillPct = hrv && lrv ? ((level - lrv) / (hrv - lrv) * 100) : null;
            const fillStyle = getFillColor(fillPct);
            const barWidth = Math.min(Math.max(fillPct || 0, 0), 120); // Cap at 120% for visual
            
            if (!latestUpdate || d.timestamp > latestUpdate) {
              latestUpdate = d.timestamp;
            }
            
            item.innerHTML = `
              <div class="reservoir-name">${reservoir}</div>
              <div class="water-level">${fmt(level, 2)} m</div>
              <div class="water-ref">LRV: ${fmt(lrv, 1)} ¬∑ HRV: ${fmt(hrv, 1)}</div>
              <div class="fill-pct ${fillStyle.class}">${fillPct !== null ? fmt(fillPct, 0) : '--'}%</div>
              <div class="fill-bar">
                <div class="fill-bar-inner" style="width: ${barWidth}%; background: ${fillStyle.color};"></div>
              </div>
            `;
          } else {
            item.innerHTML = `
              <div class="reservoir-name">${reservoir}</div>
              <div class="water-level">--</div>
              <div class="water-ref">Ingen data</div>
              <div class="fill-pct">--%</div>
              <div class="fill-bar"><div class="fill-bar-inner" style="width: 0%;"></div></div>
            `;
          }
          
          waterGrid.appendChild(item);
        }
        
        document.getElementById('waterUpdate').textContent = latestUpdate ? fmtDateTime(latestUpdate) : '--';
        
      } catch (err) {
        console.error('Feil ved henting av vannstand:', err);
      }
    }

    async function updateMetNoData() {
      try {
        // Locationforecast for current data + forecast
        const forecast = await fetchMetNo(`locationforecast/2.0/complete?lat=${METNO_LAT}&lon=${METNO_LON}`);
        
        if (forecast && forecast.properties && forecast.properties.timeseries) {
          const now = forecast.properties.timeseries[0];
          const instant = now.data.instant.details;
          
          // Current fog
          document.getElementById('fog').textContent = fmt(instant.fog_area_fraction, 0) + '%';
          
          // Precip next hour
          const precipNext = now.data.next_1_hours?.details?.precipitation_amount || 0;
          document.getElementById('precipNextHour').textContent = fmt(precipNext, 1) + ' mm';
          
          // 7-day forecast
          const dailyForecasts = {};
          for (const ts of forecast.properties.timeseries) {
            const date = getDateKey(ts.time);
            const hour = new Date(ts.time).getHours();
            
            if (!dailyForecasts[date]) {
              dailyForecasts[date] = { 
                temps: [], 
                symbol: null, 
                precip: 0,
                time: ts.time
              };
            }
            
            // Collect temps
            if (ts.data.instant?.details?.air_temperature !== undefined) {
              dailyForecasts[date].temps.push(ts.data.instant.details.air_temperature);
            }
            
            // Get symbol from noon (12:00) or first available
            if (hour === 12 && ts.data.next_6_hours?.summary?.symbol_code) {
              dailyForecasts[date].symbol = ts.data.next_6_hours.summary.symbol_code;
            } else if (!dailyForecasts[date].symbol && ts.data.next_6_hours?.summary?.symbol_code) {
              dailyForecasts[date].symbol = ts.data.next_6_hours.summary.symbol_code;
            }
            
            // Sum precipitation
            if (ts.data.next_1_hours?.details?.precipitation_amount) {
              dailyForecasts[date].precip += ts.data.next_1_hours.details.precipitation_amount;
            }
          }
          
          // Render 7-day forecast
          const forecastDays = Object.keys(dailyForecasts).sort().slice(0, 7);
          const forecastGrid = document.getElementById('forecastGrid');
          forecastGrid.innerHTML = '';
          
          for (const date of forecastDays) {
            const day = dailyForecasts[date];
            const minTemp = Math.min(...day.temps);
            const maxTemp = Math.max(...day.temps);
            
            const dayEl = document.createElement('div');
            dayEl.className = 'forecast-day';
            dayEl.innerHTML = `
              <div class="day-name">${fmtDayName(day.time)}</div>
              <div class="weather-icon">${getWeatherIcon(day.symbol)}</div>
              <div class="temp-range">
                <span class="temp-cold">${fmt(minTemp, 0)}¬∞</span> / 
                <span class="temp-warm">${fmt(maxTemp, 0)}¬∞</span>
              </div>
              ${day.precip > 0.1 ? `<div class="precip">${fmt(day.precip, 1)} mm</div>` : '<div class="precip">-</div>'}
            `;
            forecastGrid.appendChild(dayEl);
          }
        }
        
        // MetAlerts
        const alerts = await fetchMetNo(`metalerts/2.0/current.json?lat=${METNO_LAT}&lon=${METNO_LON}`);
        const alertCard = document.getElementById('alertCard');
        const alertContent = document.getElementById('alertContent');
        
        if (alerts && alerts.features && alerts.features.length > 0) {
          const alert = alerts.features[0].properties;
          const severity = alert.awareness_level || '';
          
          // Set card color based on severity
          alertCard.className = 'card alert';
          if (severity.includes('yellow') || severity.includes('Yellow')) {
            alertCard.classList.add('yellow');
          } else if (severity.includes('orange') || severity.includes('Orange')) {
            alertCard.classList.add('orange');
          } else if (severity.includes('red') || severity.includes('Red')) {
            alertCard.classList.add('red');
          }
          
          alertContent.innerHTML = `
            <div class="alert-title">${alert.eventAwarenessName || alert.event || 'Farevarsel'}</div>
            <div class="alert-desc">${alert.description || ''}</div>
          `;
        } else {
          alertCard.className = 'card alert';
          alertContent.innerHTML = '<span class="alert-none">‚úì Ingen aktive farevarsler for Siljan</span>';
        }
        
      } catch (err) {
        console.error('Feil ved henting av met.no data:', err);
      }
    }

    async function updateDashboard() {
      try {
        // Siste m√•ling
        const latest = await fetchData('weather_data', '*', '', 'recorded_at.desc', '1');
        if (latest.length > 0) {
          const d = latest[0];
          document.getElementById('temp').textContent = fmt(d.temperature);
          document.getElementById('irr').textContent = fmt(d.irradiance, 0);
          document.getElementById('rainToday').textContent = fmt(d.rain_today);
          document.getElementById('hum').textContent = fmt(d.humidity, 0);
          document.getElementById('dew').textContent = fmt(d.dew_point) + '¬∞C';
          document.getElementById('press').textContent = fmt(d.pressure, 0);
          document.getElementById('lastUpdate').textContent = fmtDateTime(d.recorded_at);
          
          // Vind
          const windSpeed = d.wind_speed || 0;
          document.getElementById('wind').textContent = fmt(windSpeed, 0);
          const beaufort = getBeaufort(windSpeed);
          const beaufortEl = document.getElementById('beaufort');
          beaufortEl.textContent = beaufort.name;
          beaufortEl.className = 'beaufort ' + beaufort.class;

          // UV-indeks
          const uvVal = d.uv_index || 0;
          document.getElementById('uv').textContent = fmt(uvVal, 1);
          const uvLevel = getUvLevel(uvVal);
          const uvLevelEl = document.getElementById('uvLevel');
          uvLevelEl.textContent = uvLevel.name;
          uvLevelEl.className = 'beaufort ' + uvLevel.class;

          // Met.no data from database
          document.getElementById('windGust').textContent = fmt(d.wind_gust, 0);
          const windDir = getWindDirection(d.wind_direction);
          document.getElementById('windDirArrow').textContent = windDir.arrow;
          document.getElementById('windDirText').textContent = windDir.text;
          document.getElementById('windDirDeg').textContent = d.wind_direction ? d.wind_direction + '¬∞' : '--';
          document.getElementById('clouds').textContent = fmt(d.cloud_cover, 0);
          document.getElementById('precipProb').textContent = fmt(d.precipitation_probability, 0) + '%';
          document.getElementById('thunderProb').textContent = fmt(d.thunder_probability, 0) + '%';

          // Siljan regional data
          document.getElementById('siljanTempMin').textContent = fmt(d.temp_min_daily) + '¬∞C';
          document.getElementById('siljanTempMax').textContent = fmt(d.temp_max_daily) + '¬∞C';
          document.getElementById('siljanRainMax').textContent = fmt(d.rain_max_daily);
          
          const siljanWind = d.wind_max_daily || 0;
          document.getElementById('siljanWindMax').textContent = fmt(siljanWind, 0);
          const siljanBeaufort = getBeaufort(siljanWind);
          const siljanBeaufortEl = document.getElementById('siljanWindBeaufort');
          siljanBeaufortEl.textContent = siljanBeaufort.name;
          siljanBeaufortEl.className = 'beaufort ' + siljanBeaufort.class;
        }

        // 24t data
        const data24h = await fetchData('weather_data', '*', `recorded_at=gte.${hoursAgo(24)}`);
        if (data24h.length > 0) {
          // Temperatur
          const temp24 = findMinMax(data24h, 'temperature');
          document.getElementById('temp24min').textContent = fmt(temp24.min.val);
          document.getElementById('temp24max').textContent = fmt(temp24.max.val);
          document.getElementById('temp24times').textContent = `(${fmtTime(temp24.min.time)} / ${fmtTime(temp24.max.time)})`;

          // Fuktighet
          const hum24 = findMinMax(data24h, 'humidity');
          document.getElementById('hum24min').textContent = fmt(hum24.min.val, 0);
          document.getElementById('hum24max').textContent = fmt(hum24.max.val, 0);
          document.getElementById('hum24times').textContent = `(${fmtTime(hum24.min.time)} / ${fmtTime(hum24.max.time)})`;

          // Trykk
          const press24 = findMinMax(data24h, 'pressure');
          document.getElementById('press24min').textContent = fmt(press24.min.val, 0);
          document.getElementById('press24max').textContent = fmt(press24.max.val, 0);
          document.getElementById('press24times').textContent = `(${fmtTime(press24.min.time)} / ${fmtTime(press24.max.time)})`;

          // Vind 24t
          const wind24 = findMinMax(data24h, 'wind_speed');
          document.getElementById('wind24max').textContent = fmt(wind24.max.val, 0) + ' km/h';
          document.getElementById('wind24time').textContent = fmtTime(wind24.max.time);

          // UV 24t
          const uv24 = findMinMax(data24h, 'uv_index');
          document.getElementById('uv24max').textContent = fmt(uv24.max.val, 1);
          document.getElementById('uv24time').textContent = fmtTime(uv24.max.time);

          // Vindkast 24t
          const gust24 = findMinMax(data24h, 'wind_gust');
          document.getElementById('gust24max').textContent = fmt(gust24.max.val, 0) + ' km/h';
          document.getElementById('gust24time').textContent = fmtTime(gust24.max.time);

          // Skydekke 24t
          const clouds24 = findMinMax(data24h, 'cloud_cover');
          document.getElementById('clouds24min').textContent = fmt(clouds24.min.val, 0) + '%';
          document.getElementById('clouds24minTime').textContent = fmtTime(clouds24.min.time);
          document.getElementById('clouds24max').textContent = fmt(clouds24.max.val, 0) + '%';
          document.getElementById('clouds24maxTime').textContent = fmtTime(clouds24.max.time);

          // Torden 24t
          const thunder24 = findMinMax(data24h, 'thunder_probability');
          document.getElementById('thunderProb24max').textContent = fmt(thunder24.max.val, 0) + '%';
          document.getElementById('thunderProb24time').textContent = fmtTime(thunder24.max.time);

          // Maks irradiance i dag
          const irr24 = findMinMax(data24h, 'irradiance');
          document.getElementById('irrMax').textContent = fmt(irr24.max.val, 0) + ' W/m¬≤';
          document.getElementById('irrMaxTime').textContent = fmtTime(irr24.max.time);

          // Solskinnstimer
          const sunMinutes24 = data24h.filter(d => d.irradiance > 120).length;
          document.getElementById('sun24').textContent = fmt(sunMinutes24 / 60) + 't';

          // Nedb√∏r 24t
          const daily24 = calcDailyRain(data24h);
          const rain24total = Object.values(daily24).reduce((sum, d) => sum + d.val, 0);
          document.getElementById('rain24').textContent = fmt(rain24total) + ' mm';
        }

        // 3t trykk-trend
        const data3h = await fetchData('weather_data', 'pressure,recorded_at', `recorded_at=gte.${hoursAgo(3)}`, 'recorded_at.asc');
        if (data3h.length > 1) {
          const first = data3h[0].pressure;
          const last = data3h[data3h.length - 1].pressure;
          const diff = last - first;
          const trendEl = document.getElementById('pressTrend');
          if (diff > 1) {
            trendEl.innerHTML = `<span class="trend-up">‚Üë +${fmt(diff, 1)}</span>`;
          } else if (diff < -1) {
            trendEl.innerHTML = `<span class="trend-down">‚Üì ${fmt(diff, 1)}</span>`;
          } else {
            trendEl.textContent = `‚Üí ${fmt(diff, 1)}`;
          }
        }

        // 7d data
        const data7d = await fetchData('weather_data', '*', `recorded_at=gte.${daysAgo(7)}`);
        if (data7d.length > 0) {
          // Temperatur
          const temp7 = findMinMax(data7d, 'temperature');
          document.getElementById('temp7min').textContent = fmt(temp7.min.val);
          document.getElementById('temp7max').textContent = fmt(temp7.max.val);
          document.getElementById('temp7times').textContent = `(${fmtShortDate(temp7.min.time)} / ${fmtShortDate(temp7.max.time)})`;

          // UV 7d
          const uv7 = findMinMax(data7d, 'uv_index');
          document.getElementById('uv7max').textContent = fmt(uv7.max.val, 1);
          document.getElementById('uv7date').textContent = fmtShortDate(uv7.max.time);

          // Siljan regional temp 7d
          const siljanTempMin7 = findMinMax(data7d, 'temp_min_daily');
          const siljanTempMax7 = findMinMax(data7d, 'temp_max_daily');
          document.getElementById('siljanTempMin7').textContent = fmt(siljanTempMin7.min.val) + '¬∞C';
          document.getElementById('siljanTempMin7date').textContent = fmtShortDate(siljanTempMin7.min.time);
          document.getElementById('siljanTempMax7').textContent = fmt(siljanTempMax7.max.val) + '¬∞C';
          document.getElementById('siljanTempMax7date').textContent = fmtShortDate(siljanTempMax7.max.time);

          // Siljan regional vind 7d
          const siljanWind7 = findMinMax(data7d, 'wind_max_daily');
          document.getElementById('siljanWind7max').textContent = fmt(siljanWind7.max.val, 0) + ' km/h';
          document.getElementById('siljanWind7date').textContent = fmtShortDate(siljanWind7.max.time);

          // Siljan regional nedb√∏r 7d
          const siljanRain7daily = calcDailyMax(data7d, 'rain_max_daily');
          const siljanRain7vals = Object.values(siljanRain7daily);
          let siljanRain7max = { val: 0, time: null };
          for (const v of siljanRain7vals) {
            if (v.val > siljanRain7max.val) siljanRain7max = v;
          }
          document.getElementById('siljanRain7max').textContent = fmt(siljanRain7max.val) + ' mm';
          document.getElementById('siljanRain7date').textContent = fmtDayMonth(siljanRain7max.time);

          // Fuktighet snitt
          const hums = data7d.map(d => d.humidity).filter(h => h !== null);
          document.getElementById('hum7avg').textContent = fmt(hums.reduce((a, b) => a + b, 0) / hums.length, 0) + '%';

          // Trykk snitt
          const presses = data7d.map(d => d.pressure).filter(p => p !== null);
          document.getElementById('press7avg').textContent = fmt(presses.reduce((a, b) => a + b, 0) / presses.length, 0);

          // Vind 7d
          const wind7 = findMinMax(data7d, 'wind_speed');
          document.getElementById('wind7max').textContent = fmt(wind7.max.val, 0) + ' km/h';
          document.getElementById('wind7time').textContent = fmtShortDate(wind7.max.time);

          // Solskinn 7d
          const sunMinutes7 = data7d.filter(d => d.irradiance > 120).length;
          document.getElementById('sun7').textContent = fmt(sunMinutes7 / 60) + 't';

          // Nedb√∏r 7d
          const daily7 = calcDailyRain(data7d);
          const rain7total = Object.values(daily7).reduce((sum, d) => sum + d.val, 0);
          document.getElementById('rain7').textContent = fmt(rain7total) + ' mm';

          // Nedb√∏r statistikk 7d
          const stats7 = calcRainStats(daily7);
          document.getElementById('rainMax7').textContent = fmt(stats7.maxDay.val) + ' mm';
          document.getElementById('rainMax7date').textContent = fmtDayMonth(stats7.maxDay.date);
          document.getElementById('rainDays7').textContent = stats7.rainDays;
        }

        // 30d data
        const data30d = await fetchData('weather_data', '*', `recorded_at=gte.${daysAgo(30)}`);
        if (data30d.length > 0) {
          // Temperatur
          const temp30 = findMinMax(data30d, 'temperature');
          document.getElementById('temp30min').textContent = fmt(temp30.min.val);
          document.getElementById('temp30max').textContent = fmt(temp30.max.val);
          document.getElementById('temp30times').textContent = `(${fmtShortDate(temp30.min.time)} / ${fmtShortDate(temp30.max.time)})`;

          // UV 30d
          const uv30 = findMinMax(data30d, 'uv_index');
          document.getElementById('uv30max').textContent = fmt(uv30.max.val, 1);
          document.getElementById('uv30date').textContent = fmtShortDate(uv30.max.time);

          // Siljan regional temp 30d
          const siljanTempMin30 = findMinMax(data30d, 'temp_min_daily');
          const siljanTempMax30 = findMinMax(data30d, 'temp_max_daily');
          document.getElementById('siljanTempMin30').textContent = fmt(siljanTempMin30.min.val) + '¬∞C';
          document.getElementById('siljanTempMin30date').textContent = fmtShortDate(siljanTempMin30.min.time);
          document.getElementById('siljanTempMax30').textContent = fmt(siljanTempMax30.max.val) + '¬∞C';
          document.getElementById('siljanTempMax30date').textContent = fmtShortDate(siljanTempMax30.max.time);

          // Siljan regional vind 30d
          const siljanWind30 = findMinMax(data30d, 'wind_max_daily');
          document.getElementById('siljanWind30max').textContent = fmt(siljanWind30.max.val, 0) + ' km/h';
          document.getElementById('siljanWind30date').textContent = fmtShortDate(siljanWind30.max.time);
          
          // Siljan vind snitt
          const siljanWindVals = data30d.map(d => d.wind_max_daily).filter(w => w !== null);
          const siljanWindAvg = siljanWindVals.length > 0 ? siljanWindVals.reduce((a, b) => a + b, 0) / siljanWindVals.length : 0;
          document.getElementById('siljanWindAvg').textContent = fmt(siljanWindAvg, 0) + ' km/h';

          // Siljan regional nedb√∏r 30d
          const siljanRain30daily = calcDailyMax(data30d, 'rain_max_daily');
          const siljanRain30vals = Object.values(siljanRain30daily);
          let siljanRain30max = { val: 0, time: null };
          let siljanRain30total = 0;
          for (const v of siljanRain30vals) {
            if (v.val > siljanRain30max.val) siljanRain30max = v;
            siljanRain30total += v.val;
          }
          document.getElementById('siljanRain30max').textContent = fmt(siljanRain30max.val) + ' mm';
          document.getElementById('siljanRain30date').textContent = fmtDayMonth(siljanRain30max.time);
          document.getElementById('siljanRainAvg').textContent = fmt(siljanRain30total / siljanRain30vals.length) + ' mm';

          // Vind 30d
          const wind30 = findMinMax(data30d, 'wind_speed');
          document.getElementById('wind30max').textContent = fmt(wind30.max.val, 0) + ' km/h';
          document.getElementById('wind30time').textContent = fmtShortDate(wind30.max.time);

          // Nedb√∏r 30d
          const daily30 = calcDailyRain(data30d);
          const rain30total = Object.values(daily30).reduce((sum, d) => sum + d.val, 0);
          document.getElementById('rain30').textContent = fmt(rain30total) + ' mm';

          // Nedb√∏r statistikk 30d
          const stats30 = calcRainStats(daily30);
          document.getElementById('rainMax30').textContent = fmt(stats30.maxDay.val) + ' mm';
          document.getElementById('rainMax30date').textContent = fmtDayMonth(stats30.maxDay.date);
          document.getElementById('rainDays30').textContent = stats30.rainDays;
          document.getElementById('dryStreak').textContent = stats30.maxDryStreak + ' dager';
          document.getElementById('rainAvgPerDay').textContent = fmt(stats30.avgPerRainDay) + ' mm';
        }

      } catch (err) {
        console.error('Feil ved henting av data:', err);
      }
    }

    // Initial load
    updateDashboard();
    updateMetNoData();
    updateWaterLevels();
    
    // Refresh intervals
    setInterval(updateDashboard, 60000);       // Database data every minute
    setInterval(updateMetNoData, 900000);      // Met.no data every 15 minutes
    setInterval(updateWaterLevels, 3600000);   // Water levels every hour
  </script>
</body>
</html>
